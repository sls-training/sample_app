# API 設計書

## ユーザーのマイクロポストを返す API

### 概要

- ユーザーのマイクロポストを返す API

  - 認証用 API で返ってきたものを使って認証する
    - get リクエストでユーザーのマイクロポストのデータを持ってくる際に、header で送った認証用の token が user table の auth_token に存在するかを確認する
    - その後、その token の有効期限が切れていないかを expiration_date の時刻と比較する
  - token が存在し、有効期限も大丈夫だった場合にマイクロポストを取得する処理に入る
  - token が存在しなかった場合、有効期限が切れていた場合はエラーを返す

  - ユーザー ID を指定して、ユーザーが DB に存在すればそのユーザーのマイクロポストを返す
    - パラメータとして表示ページ、表示するマイクロポストの数を指定できる
      - 指定しなければ表示ページには 1、マイクロポスト数には 30 が入る
  - マイクロポストは降順で表示される
    - マイクロポストが投稿されていない、もしくは指定したページに表示するマイクロポストがなければ空の json([])を返す
  - エラーを返す
    - 暗号化されたユーザー ID で検索した結果存在しなかった場合
  - トークンが一致しなかった場合
    - 無効な値、ユーザーが存在しない場合

### メソッド

- GET

### URI

- /api/v1/users/{user_id}/microposts{page}{per_page}

### パラメータ

| パラメータ名 | 型      | 内容                                                                                                                                    |
| ------------ | ------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| user_id      | Integer | ユーザー ID を数字で指定                                                                                                                |
| page         | Integer | 表示したいページ数を数字で指定<br>デフォルトは 1                                                                                        |
| per_page     | Integer | 表示したいマイクロポストの数を数字で指定<br>デフォルトは 30<br>表示したページのマイクロポストが指定した数より少なければある分だけを表示 |

### リクエスト

- Headers

```
Authorization: xxxxxx
```

### レスポンス

#### 成功時

##### ステータスコード

- 200

##### レスポンスサンプル

- 表示するマイクロポストが存在する場合

```
{
	"microposts": [
		{
			"id": 295,
			"content": "Possimus facilis repellat odit dolore.",
			"user_id": 1,
			"created_at": "2022-04-18T07:54:54.387Z",
			"updated_at": "2022-04-18T07:54:54.387Z"
		},
		{
			"id": 289,
			"content": "Ut voluptatem sed expedita nam.",
			"user_id": 1,
			"created_at": "2022-04-18T07:54:54.362Z",
			"updated_at": "2022-04-18T07:54:54.362Z"
		},
		{
			"id": 283,
			"content": "Sequi et voluptas quod beatae.",
			"user_id": 1,
			"created_at": "2022-04-18T07:54:54.338Z",
			"updated_at": "2022-04-18T07:54:54.338Z"
		},
  ~~~~ # 省略
		{
			"id": 121,
			"content": "Cumque possimus ipsa quaerat non.",
			"user_id": 1,
			"created_at": "2022-04-18T07:54:53.645Z",
			"updated_at": "2022-04-18T07:54:53.645Z"
		}
	]
}
```

- 表示するマイクロポストが存在しない場合

```
{
  "microposts": []
}
```

#### 失敗時

##### ステータスコード

- 404

##### レスポンスサンプル

```
{
  "error": {
    "status": 404,
    "message": "not found"
  }
}
```

---

## 認証用 API

### 概要

- メールアドレスとパスワードを受け取り、そのユーザーが DB に存在すれば成功、存在しなければ失敗を返す
- 有効期限が切れる前にアクセスがあり、有効な値の場合は DB の中身(トークン・有効期限)も更新する
  - 成功
    - token として長さ 22 のランダムな base64 文字列を生成する
    - userid:token の形を base64 エンコードしたものと、有効期限の時刻を返す
      - user table の auth_token に base64 エンコードしたものを保存する
      - user table の expiration_date に有効期限として成功時の時刻から 30 分後の時刻を保存する
  - 失敗
    - 401 エラーを返す

### メソッド

- POST

### URI

- /api/v1/auth

### リクエスト

```
{
  "email": "test@example.com",
  "password":"aiueo123"
}
```

### レスポンス

#### 成功時

##### ステータスコード

- 200

##### レスポンスサンプル

```
{
    "auth": "MTAxOkd2dDdEMGR6bXFhNFlnZ0pmLVNST2c=",
    "expiration_date": "2022-05-24 12:54:12 +0900"
}
```

#### 失敗時

##### ステータスコード

- 401

#### レスポンスサンプル

```
{
  "error": {
    "status": 401,
    "message": "Unauthorized"
  }
}
```
